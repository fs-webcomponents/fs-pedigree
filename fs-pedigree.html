<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../fs-api-aware/fs-api-aware.html">
<link rel="import" href="fs-pedigree-ancestor-group.html">

<!--
Display a FamilySearch person's pedigree.

    <fs-pedigree person-id="PPPP-PPP"></fs-pedigree>
    
@customElement
@polymer
@demo demo/index.html
-->
<dom-module id="fs-pedigree">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
      }
    </style>
    <div id="groups"></div>
  </template>

  <script>
    class FsPedigree extends FSApiAwareMixin(Polymer.Element) {
  
      static get is() { return 'fs-pedigree'; }
      
      /**
       * Fired when a person is tapped. The event details will contain the same
       * details as a click event with an added `personId` property.
       *
       * @event person-tap
       * @param {{personId:string}} ID of the person that was clicked.
       */
      
      static get properties() {
        return {
          
          /** ID of the root person */
          personId: {
            type: String
          },
          
          /** 
           * ID of the root person's spouse, if known. When not specified, the
           * API will automatically choose a spouse. You may set this property
           * to specify which spouse will be loaded.
           */
          spouseId: {
            type: String,
            value: ''
          },
          
          /** Whether to show the "+ Add Person" buttons in the pedigree when a person is missing */
          addPersons: {
            type: Boolean,
            value: false
          }
        };
      }
      
      ready() {
        super.ready();
        
        // Start setup by appending the root group
        this._addGroup(this.personId, this.spouseId, true);
        
        // Add a new group when the pedigree is extended
        this.addEventListener('extend-couple', (e) => {
          this._addGroup(e.detail.husbandId, e.detail.wifeId, false, e.detail.level + 1, e.detail.left, e.detail.top);
        });
        
        // Collapse the pedigree when collapse buttons are clicked
        this.addEventListener('collapse-couple', (e) => {
          this._collapseTo(e.detail.level);
        });
      }
      
      reload() {
        // TODO: How will this be done?
        // this.$.request.generateRequest();
      }
      
      _addGroup(personId, spouseId, root, level, left, top) {
        const group = document.createElement('fs-pedigree-ancestor-group');
        group.personId = personId;
        group.spouseId = spouseId;
        group.rootGroup = root;
        group.clientName = this.clientName;
        if(level) {
          group.level = level;
          this._removeLevels(level);
        }
        if(left && top) {
          group.positionWithCouple(left, top);
        }
        // We want the new groups to be layered underneath previous groups
        // so we add the new groups before the existing groups in the DOM.
        this.$.groups.prepend(group);
      }
      
      /**
       * Collapse to the given level by removing all level greater than it.
       */
      _collapseTo(level) {
        this._removeLevels(level + 1);
      }
      
      /**
       * Remove groups from any level greater than or equal to the given level.
       */
      _removeLevels(level) {
        Array.from(this.$.groups.children).forEach((group) => {
          if(group.level >= level) {
            group.remove();
          }
        });
      }
      
    }
    
    customElements.define(FsPedigree.is, FsPedigree);
  </script>
</dom-module>
