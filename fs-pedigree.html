<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../fs-api-aware/fs-api-aware.html">
<link rel="import" href="fs-pedigree-ancestor-group.html">

<!--
Display a FamilySearch person's pedigree.

    <fs-pedigree person-id="PPPP-PPP"></fs-pedigree>
    
@customElement
@polymer
@demo demo/index.html
-->
<dom-module id="fs-pedigree">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        cursor: move;
      }
    </style>
    <div id="groups"></div>
  </template>

  <script>
    class FsPedigree extends FSApiAwareMixin(Polymer.Element) {
  
      static get is() { return 'fs-pedigree'; }
      
      /**
       * Fired when a person is tapped. The event details will contain the same
       * details as a click event with an added `personId` property.
       *
       * @event person-tap
       * @param {{personId:string}} ID of the person that was clicked.
       */
      
      static get properties() {
        return {
          
          /** ID of the root person */
          personId: {
            type: String
          },
          
          /** 
           * ID of the root person's spouse, if known. When not specified, the
           * API will automatically choose a spouse. You may set this property
           * to specify which spouse will be loaded.
           */
          spouseId: {
            type: String,
            value: ''
          },
          
          /** Whether to show the "+ Add Person" buttons in the pedigree when a person is missing */
          addPersons: {
            type: Boolean,
            value: false
          },
          
          /** Whether we're panning */
          _panning: {
            type: Boolean,
            value: false
          },
          
          /** Where panning started */
          _startPanX: {
            type: Number,
            value: 0
          },
          _startPanY: {
            type: Number,
            value: 0
          },
          
          /** How much we've panned */
          _netPanX: {
            type: Number,
            value: 0
          },
          _netPanY: {
            type: Number,
            value: 0
          }
        };
      }
      
      ready() {
        super.ready();
        
        // Start setup by appending the root group
        this._addGroup(this.personId, this.spouseId, true);
        
        // Enable panning
        this.addEventListener('mousedown', this._startPanning.bind(this));
        this.addEventListener('mouseup', this._endPanning.bind(this));
        this.addEventListener('mousemove', this._pan.bind(this));
      }
      
      reload() {
        // TODO: How will this be done?
        // this.$.request.generateRequest();
      }
      
      _addGroup(personId, spouseId, root) {
        const group = document.createElement('fs-pedigree-ancestor-group');
        group.personId = personId;
        group.spouseId = spouseId;
        group.rootGroup = root;
        group.clientName = this.clientName;
        this.$.groups.appendChild(group);
      }
      
      /**
       * Collapse to the given level by removing all level greater than it.
       */
      _collapseTo(level) {
        this._removeLevels(level + 1);
      }
      
      /**
       * Remove groups from any level greater than or equal to the given level.
       */
      _removeLevels(level) {
        Array.from(this.$.groups.children).forEach((group) => {
          if(group.level >= level) {
            group.remove();
          }
        });
      }
      
      _startPanning(e) {
        this._panning = true;
        this._startPanX = e.pageX;
        this._startPanY = e.pageY;
      }
      
      _endPanning(e) {
        this._panning = false;
        this._startPanX = 0;
        this._startPanY = 0;
      }
      
      _pan(e) {
        if(!this._panning) {
          return;
        }
        
        // Pan
        this._netPanX += e.pageX - this._startPanX;
        this._netPanY += e.pageY - this._startPanY;
        this.style.transform = `translate(${this._netPanX}px, ${this._netPanY}px)`;
        
        // Update starting position for next calculation
        this._startPanX = e.pageX;
        this._startPanY = e.pageY;
      }
      
    }
    
    customElements.define(FsPedigree.is, FsPedigree);
  </script>
</dom-module>
