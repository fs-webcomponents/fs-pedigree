<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../fs-request/fs-request.html">
<link rel="import" href="../fs-api-aware/fs-api-aware.html">
<link rel="import" href="fs-pedigree-person.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">

<!--
Display a FamilySearch person's pedigree. Currently it only supports displaying
3 generations of ancestors: parents, grandparents, and great-grandparents.

    <fs-pedigree person-id="PPPP-PPP"></fs-pedigree>
    
@group FamilySearch Elements
@customElement
@polymer
@demo demo/index.html
-->
<dom-module id="fs-pedigree">
  <template>
    <style>
      :host {
        display: block;
      }
      
      #pedigree {
        display: flex;
      }
      
      .column {
        padding: 0 var(--fs-pedigree-column-padding, 16px);
        display: flex;
        flex-direction: column;
        justify-content: space-around;
      }
      
      fs-pedigree-person {
        width: var(--fs-pedigree-person-width, 250px);
        margin: var(--fs-pedigree-person-vertical-margin, 8px) 0;
        position: relative;
      }
      
      fs-pedigree-person[father]:after,
      fs-pedigree-person[mother]:after {
        content: '';
        height: 60px;
        display: block;
        position: absolute;
        border-color: #888;
        border-style: solid;
        border-radius: 5px;
        border-width: 0;
        z-index: -1;
        width: 33%;
        left: -25%;
      }
      
      fs-pedigree-person[father]:after {
        top: 50%;
        border-width: 1px 0 0 1px;
      }
      
      fs-pedigree-person[mother]:after {
        bottom: 50%;
        border-width: 0 0 1px 1px;
      }
      
      fs-pedigree-person[parent]:after {
        height: 250%;
      }
      
      fs-pedigree-person[grandparent]:after {
        height: 125%;
      }
      
      fs-pedigree-person[greatgrandparent]:after {
        height: 62.5%;
      }
      
      fs-pedigree-person[greatgrandparent][father]:after {
        top: 35%;
      }
      
      fs-pedigree-person[greatgrandparent][mother]:after {
        bottom: 35%;
      }
    </style>
    <fs-request
      id="request"
      auto
      client-name="[[clientName]]"
      require-authentication
      url="{{_computeUrl(personId)}}"
      on-loading-changed="_updateLoading"
      on-response="_handleResponse"></fs-client>
    <div id="pedigree">
      
      <!-- root person -->
      <div class="column">
        <fs-pedigree-person person="{{pedigree.1}}" id="p1" position="1"></fs-pedigree-person>
      </div>
      
      <!-- parents -->
      <div class="column">
        <fs-pedigree-person person="{{pedigree.2}}" id="p2" position="2" parent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.3}}" id="p3" position="3" parent mother></fs-pedigree-person>
      </div>
      
      <!-- grandparents -->
      <div class="column">
        <fs-pedigree-person person="{{pedigree.4}}" id="p4" position="4" grandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.5}}" id="p5" position="5" grandparent mother></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.6}}" id="p6" position="6" grandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.7}}" id="p7" position="7" grandparent mother></fs-pedigree-person>
      </div>
      
      <!-- great-grandparents -->
      <div class="column">
        <fs-pedigree-person person="{{pedigree.8}}" id="p8" position="8" greatgrandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.9}}" id="p9" position="9" greatgrandparent mother></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.10}}" id="p10" position="10" greatgrandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.11}}" id="p11" position="11" greatgrandparent mother></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.12}}" id="p12" position="12" greatgrandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.13}}" id="p13" position="13" greatgrandparent mother></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.14}}" id="p14" position="14" greatgrandparent father></fs-pedigree-person>
        <fs-pedigree-person person="{{pedigree.15}}" id="p15" position="15" greatgrandparent mother></fs-pedigree-person>
      </div>
    </div>
  </template>

  <script>
    class FSPedigree extends Polymer.GestureEventListeners(FSApiAwareMixin(Polymer.Element)) {
  
      static get is() { return 'fs-pedigree'; }
      
      /**
       * Fired when a person is tapped. The event details will contain the same
       * details as a click event with an added `personId` property.
       *
       * @event person-tap
       * @param {{personId:string}} ID of the person that was clicked.
       */
      
      static get properties() {
        return {
          personId: {
            type: String,
            observer: '_personIdChanged',
            reflectToAttribute: true
          },
          loading: {
            type: Boolean,
            readOnly: true,
            value: false,
            notify: true
          },
          pedigree: Object,
          
          /** Whether to show the "+ Add Person" buttons in the pedigree when a person is missing */
          addPersons: {
            type: Boolean,
            value: false
          }
        };
      }
      
      connectedCallback() {
        super.connectedCallback();
        this.shadowRoot.querySelectorAll('fs-pedigree-person').forEach(($person) => {
          $person.addEventListener('click', (e) => {
            
            // An existing person was clicked
            if($person.person && $person.person.id) {
              this._personTap($person.person.id, e);
            }
            
            // An "+ Add Person" button was clicked
            else if($person.addPerson) {
              this._addPerson($person, e);
            }
          });
        });
      }
      
      reload() {
        this.$.request.generateRequest();
      }
      
      _updateLoading(e) {
        this._setLoading(e.detail.value);
      }
      
      _personTap(personId, event) {
        this.dispatchEvent(new CustomEvent('person-tap', {
          detail: {
            sourceEvent: event,
            personId
          },
          bubbles: true,
          composed: true
        }));
      }
      
      /**
       * Emit the add-persone event
       */
      _addPerson($person, event) {
        
        // We need to calculate the childId and parent IDs. We know the
        // ahnentafel position so we can calculate the position of the child
        // and other spouse then lookup their IDs.
        
        const detail = {
          sourceEvent: event
        };
        const position = $person.position;
        let childPosition;
        
        // Male, father
        if(position % 2 === 0) {
          childPosition = position / 2;
          const mother = this.pedigree[position + 1];
          if(mother && mother.id) {
            detail.motherId = mother.id;
          }
        } 
        
        // Female
        else {
          const fatherPosition = position - 1;
          childPosition = fatherPosition / 2;
          const father = this.pedigree[fatherPosition];
          if(father && father.id) {
            detail.fatherId = father.id;
          }
        }
        
        const child = this.pedigree[childPosition];
        if(child && child.id) {
          detail.childId = child.id;
        }
        
        this.dispatchEvent(new CustomEvent('add-person', {
          detail,
          bubbles: true,
          composed: true
        }));
      }
      
      _personIdChanged() {
        this.pedigree = {};
      }
      
      _computeUrl() {
        if(this.personId) {
          return `/platform/tree/ancestry?person=${this.personId}`;
        }
      }
      
      _handleResponse(e) {
        if(e.detail.response.data) {
          this._setupPedigree(e.detail.response.data.persons);
        }
      }
      
      _setupPedigree(persons) {
        this.pedigree = {};
        for(var i = 0; i < persons.length; i++){
          this.set('pedigree.' + persons[i].display.ascendancyNumber, persons[i]);
        }
        this._resetAddPersons();
        this._calculateAddPerson(1);
      }
      
      _getPersonElement(position) {
        return this.$[`p${position}`];
      }
      
      /**
       * Reset the `addPerson` property for all person positions
       */
      _resetAddPersons() {
        for(let i = 1; i <= 15; i++) {
          this._getPersonElement(i).addPerson = false;
        }
      }
      
      /**
       * Calculate which cells are available for adding people.
       * We could accomplish this by traversing the pedigree recursively:
       * If a person exists, continue. If a person doesn't exist, toggle the
       * add-person behavior at that position and stop. Also stop if we reach
       * the end of the loaded pedigree.
       */
      _calculateAddPerson(position) {
        
        if(position > 15) {
          return;
        }
        
        // This person exists so recurse on their parents
        if(this.pedigree[position]) {
          // In ahnentafel numbers the father is calculated by multiplying by 2
          // and the mother's number is calculated by multiplying by 2 and adding 1
          const twice = position * 2;
          this._calculateAddPerson(twice);
          this._calculateAddPerson(twice + 1);
        } 
        
        // This person doesn't exist so enable the add person behavior and stop.
        else {
          this._getPersonElement(position).addPerson = true;
          return;
        }
      }
    }
    
    customElements.define(FSPedigree.is, FSPedigree);
  </script>
</dom-module>
